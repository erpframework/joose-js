(function(C){function A(){this._nextId=0;this._inst=[];this._curInst=null;this._colorpickerShowing=false;this._colorPickerDiv=C('<div id="colorPickerDiv"></div>')}C.extend(A.prototype,{markerClassName:"hasColorPicker",_register:function(D){var E=this._nextId++;this._inst[E]=D;return E},_getInst:function(D){return this._inst[D]||D},_doKeyDown:function(E){var D=C.colorPicker._getInst(this._colId);if(C.colorPicker._colorpickerShowing){switch(E.keyCode){case 9:C.colorPicker.hideColorPicker();break;case 27:C.colorPicker.hideColorPicker();break}}else{if(E.keyCode==40){C.colorPicker.showFor(this)}}},_resetSample:function(E){var D=C.colorPicker._getInst(this._colId);D._sampleSpan.css("backgroundColor",D._input.value)},_hasClass:function(E,F){var D=E.attr("class");return(D&&D.indexOf(F)>-1)},showFor:function(H){H=(H.jquery?H[0]:(typeof H=="string"?C(H)[0]:H));var E=(H.nodeName&&H.nodeName.toLowerCase()=="input"?H:this);if(C.colorPicker._lastInput==E){return}if(C.colorPicker._colorpickerShowing){return}var F=C.colorPicker._getInst(E._colId);C.colorPicker.hideColorPicker();C.colorPicker._lastInput=E;if(!C.colorPicker._pos){C.colorPicker._pos=C.colorPicker._findPos(E);C.colorPicker._pos[1]+=E.offsetHeight}var G=true;if(G&&C.browser.opera){C.colorPicker._pos[0]-=document.documentElement.scrollLeft;C.colorPicker._pos[1]-=document.documentElement.scrollTop}var D=F._colorPickerDiv.height();if(D==0){D=188}F._colorPickerDiv.css("position",(C.blockUI?"static":(G?"fixed":"absolute"))).css("left",C.colorPicker._pos[0]+150+"px").css("top",C.colorPicker._pos[1]+1-D+"px");C.colorPicker._pos=null;C.colorPicker._showColorPicker(F);return this},_findPos:function(D){var E=C(D).offset();return[E.left,E.top]},_checkExternalClick:function(D){if(!C.colorPicker._curInst){return}var E=C(D.target);if((E.parents("#colorPickerDiv").length==0)&&C.colorPicker._colorpickerShowing&&!(C.blockUI)){if(E.text()!=C.colorPicker._curInst._colorPickerDiv.text()){C.colorPicker.hideColorPicker()}}},hideColorPicker:function(D){var E=this._curInst;if(!E){return}if(this._colorpickerShowing){this._colorpickerShowing=false;this._lastInput=null;this._colorPickerDiv.css("position","absolute").css("left","0px").css("top","-1000px");if(C.blockUI){C.unblockUI();C("body").append(this._colorPickerDiv)}this._curInst=null}if(E._input[0].value!=E._sampleSpan.css("backgroundColor")){E._sampleSpan.css("backgroundColor",E._input[0].value)}},_connectColorPicker:function(F,E){var D=C(F);if(this._hasClass(D,this.markerClassName)){return}C(D).attr("autocomplete","OFF");E._input=C(D);E._sampleSpan=C('<span class="ColorPickerDivSample" style="background-color:'+E._input[0].value+";height:"+E._input[0].offsetHeight+';">&nbsp;</span>');D.after(E._sampleSpan);E._sampleSpan.click(function(){D.focus()});D.click(this.showFor);D.focus(this.showFor);D.addClass(this.markerClassName).keydown(this._doKeyDown);D[0]._colId=E._id},_showColorPicker:function(E){var D=this._getInst(E);this._updateColorPicker(D);D._colorPickerDiv.css("width",D._startTime!=null?"10em":"6em");D._colorPickerDiv.show();if(D._input[0].type!="hidden"){D._input[0].focus()}this._curInst=D;this._colorpickerShowing=true},refreshSamples:function(){C(".ColorPickerDivSample").each(function(){C(this).css("backgroundColor",C(this).parent().find(".colorPicker").val())})},_updateColorPicker:function(D){D._colorPickerDiv.empty().append(D._generateColorPicker());if(D._input&&D._input[0].type!="hidden"){D._input[0].focus();C("td.color",D._timePickerDiv).unbind().mouseover(function(){D._sampleSpan.css("backgroundColor",C(this).css("backgroundColor"))}).click(function(){D._setValue(this)})}}});function B(){this._id=C.colorPicker._register(this);this._input=null;this._colorPickerDiv=C.colorPicker._colorPickerDiv;this._sampleSpan=null}C.extend(B.prototype,{_get:function(D){return(this._settings[D]!=null?this._settings[D]:C.colorPicker._defaults[D])},_getValue:function(){if(this._input&&this._input[0].type!="hidden"&&this._input[0].value!=""){return this._input[0].value}return null},_setValue:function(D){if(this._input&&this._input[0].type!="hidden"){this._input[0].value=C.attr(D,"title");C(this._input[0]).change()}C.colorPicker.hideColorPicker()},_generateColorPicker:function(){var D=new Array("#000000","#000033","#000066","#000099","#0000CC","#0000FF","#330000","#330033","#330066","#330099","#3300CC","#3300FF","#660000","#660033","#660066","#660099","#6600CC","#6600FF","#990000","#990033","#990066","#990099","#9900CC","#9900FF","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#003300","#003333","#003366","#003399","#0033CC","#0033FF","#333300","#333333","#333366","#333399","#3333CC","#3333FF","#663300","#663333","#663366","#663399","#6633CC","#6633FF","#993300","#993333","#993366","#993399","#9933CC","#9933FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#006600","#006633","#006666","#006699","#0066CC","#0066FF","#336600","#336633","#336666","#336699","#3366CC","#3366FF","#666600","#666633","#666666","#666699","#6666CC","#6666FF","#996600","#996633","#996666","#996699","#9966CC","#9966FF","#CC6600","#CC6633","#CC6666","#CC6699","#CC66CC","#CC66FF","#FF6600","#FF6633","#FF6666","#FF6699","#FF66CC","#FF66FF","#009900","#009933","#009966","#009999","#0099CC","#0099FF","#339900","#339933","#339966","#339999","#3399CC","#3399FF","#669900","#669933","#669966","#669999","#6699CC","#6699FF","#999900","#999933","#999966","#999999","#9999CC","#9999FF","#CC9900","#CC9933","#CC9966","#CC9999","#CC99CC","#CC99FF","#FF9900","#FF9933","#FF9966","#FF9999","#FF99CC","#FF99FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#66CC00","#66CC33","#66CC66","#66CC99","#66CCCC","#66CCFF","#99CC00","#99CC33","#99CC66","#99CC99","#99CCCC","#99CCFF","#CCCC00","#CCCC33","#CCCC66","#CCCC99","#CCCCCC","#CCCCFF","#FFCC00","#FFCC33","#FFCC66","#FFCC99","#FFCCCC","#FFCCFF","#00FF00","#00FF33","#00FF66","#00FF99","#00FFCC","#00FFFF","#33FF00","#33FF33","#33FF66","#33FF99","#33FFCC","#33FFFF","#66FF00","#66FF33","#66FF66","#66FF99","#66FFCC","#66FFFF","#99FF00","#99FF33","#99FF66","#99FF99","#99FFCC","#99FFFF","#CCFF00","#CCFF33","#CCFF66","#CCFF99","#CCFFCC","#CCFFFF","#FFFF00","#FFFF33","#FFFF66","#FFFF99","#FFFFCC","#EEEEEE","#111111","#222222","#333333","#444444","#555555","#666666","#777777","#888888","#999999","#A5A5A5","#AAAAAA","#BBBBBB","#C3C3C3","#CCCCCC","#D2D2D2","#DDDDDD","#E1E1E1","#FFFFFF");var H=D.length;var G=18;var F="<table border='1px' cellspacing='0' cellpadding='0'>";for(var E=0;E<H;E++){if((E%G)==0){F+="<tr>"}F+='<td class="color" title="'+D[E]+'" style="background-color:'+D[E]+'"><label>&nbsp;&nbsp;&nbsp;</label></td>';if(((E+1)>=H)||(((E+1)%G)==0)){F+="</tr>"}}F+='<tr><td title="" style="background-color:#999" class="color" colspan="'+G+'" align="center"><label>No Color</label></td></tr>';F+="</table>";return F}});C.fn.attachColorPicker=function(){return this.each(function(){var E=this.nodeName.toLowerCase();if(E=="input"){var D=new B();C.colorPicker._connectColorPicker(this,D)}})};C.fn.getValue=function(){var D=(this.length>0?C.colorPicker._getInst(this[0]._colId):null);return(D?D._getValue():null)};C.fn.setValue=function(E){var D=(this.length>0?C.colorPicker._getInst(this[0]._colId):null);if(D){D._setValue(E)}};C(document).ready(function(){C.colorPicker=new A();C(document.body).append(C.colorPicker._colorPickerDiv).mousedown(C.colorPicker._checkExternalClick)})})(jQuery);var joosetop=this;Joose=function(){this.cc=null;this.currentModule=null;this.top=joosetop;this.globalObjects=[];this.anonymouseClassCounter=0};Joose.A={};Joose.A.each=function(E,F){for(var D=0;D<E.length;D++){F(E[D],D)}};Joose.A.exists=function(E,F){for(var D=0;D<E.length;D++){if(E[D]==F){return true}}return false};Joose.A.concat=function(C,D){C.push.apply(C,D);return C};Joose.A.grep=function(E,F){var D=[];Joose.A.each(E,function(A){if(F(A)){D.push(A)}});return D};Joose.A.remove=function(E,F){var D=[];Joose.A.each(E,function(A){if(A!==F){D.push(A)}});return D};Joose.S={};Joose.S.uppercaseFirst=function(D){var E=D.substr(0,1);var F=D.substr(1,D.length-1);E=E.toUpperCase();return E+F};Joose.S.isString=function(B){if(typeof B=="string"){return true}return false};Joose.O={};Joose.O.each=function(D,E){for(var F in D){E(D[F],F)}};Joose.O.eachSafe=function(D,E){for(var F in D){if(D.hasOwnProperty(F)){E(D[F],F)}}};Joose.O.extend=function(F,G){for(var H in G){var E=G[H];F[H]=E}};Joose.prototype={addToString:function(C,D){C.toString=D},isInstance:function(B){if(!B.meta){throw"isInstance only works with Joose objects and classes."}if(B.constructor===B.meta.c){return true}return false},init:function(){this.builder=new Joose.Builder();this.builder.globalize()},components:function(){return["Joose.Builder","Joose.Class","Joose.Method","Joose.ClassMethod","Joose.Attribute","Joose.Role","Joose.SimpleRequest","Joose.Gears","Joose.Storage","Joose.Storage.Unpacker","Joose.Decorator","Joose.Module","Joose.Prototype","Joose.TypeConstraint","Joose.TypeCoercion","Joose.Types"]},loadComponents:function(D){var C="";Joose.A.each(this.components(),function(A){var B=""+D+"/"+A.split(".").join("/")+".js";C+='<script type="text/javascript" src="'+B+'"><\/script>'});document.write(C)}};Joose.copyObject=function(F,E){var D="";Joose.O.each(F,function(A,B){D+=", "+B;E[B]=A});return E};Joose.emptyFunction=function(){};var joose=new Joose();Joose.bootstrap=function(){var D=new Joose.MetaClassBootstrap();D.builder=Joose.MetaClassBootstrap;Joose.MetaClass=D.createClass("Joose.MetaClass");Joose.MetaClass.meta.addNonJooseSuperClass("Joose.MetaClassBootstrap",D);Joose.MetaClass.meta.addMethod("initialize",function(){this._name="Joose.MetaClass"});var C=new Joose.MetaClass();C.builder=Joose.MetaClass;Joose.Class=C.createClass("Joose.Class");Joose.Class.meta.addSuperClass(Joose.MetaClass);Joose.MetaClass.meta.addMethod("initialize",function(){this._name="Joose.Class"})};Joose.bootstrap2=function(){Joose.Builder.Globals.joosify("Joose.Method",Joose.Method);Joose.Builder.Globals.joosify("Joose.Attribute",Joose.Attribute)};Joose.bootstrap3=function(){};Joose.MetaClassBootstrap=function(){this._name="Joose.MetaClassBootstrap";this.methodNames=[];this.attributeNames=["_name","isAbstract","isDetached","methodNames","attributeNames","methods","parentClasses","roles","c"];this.attributes={},this.methods={};this.classMethods={};this.parentClasses=[];this.roles=[];this.myRoles=[];this.isAbstract=false;this.isDetached=false};Joose.MetaClassBootstrap.prototype={toString:function(){if(this.meta){return"a "+this.meta.className()}return"NoMeta"},className:function(){return this._name},getName:function(){return this.className()},newMetaClass:function(){var H=this;var E=this.builder;var F=new E();F.builder=E;F._name=this._name;F.methodNames=[];F.attributeNames=[];F.methods={};F.classMethods={};F.parentClasses=[];F.roles=[];F.myRoles=[];F.attributes={};var G=this.meta;if(!G){G=this}F.meta=G;return F},createClass:function(L,G,J){var I=this.newMetaClass();var H;if(G){H=G}else{H=this.defaultClassFunctionBody();if(J){J.addElement(H)}}H.prototype.meta=I;H.meta=I;if(L==null){I._name="__anonymous__"}else{var K=L;if(J){K=J.getName()+"."+L}I._name=K}I.c=H;if(!J){joose.globalObjects.push(H)}I.addInitializer();I.addToString();I.addDetacher();return H},buildComplete:function(){},initializeFromProps:function(B){this._initializeFromProps(B)},_initializeFromProps:function(H){var G=this;if(H){Joose.O.eachSafe(H,function(A,B){var C=A;var D="handleProp"+B;if(G.meta.can(D)){G[D](C,H)}else{throw new Error("Called invalid builder "+B+" while creating class "+G.className())}});for(var E=0;E<this.roles.length;E++){var F=this.roles[E];F.meta.applyMethodModifiers(this.c)}G.buildComplete();G.validateClass()}},instantiate:function(){var C=function(){};C.prototype=this.c.prototype;C.prototype.constructor=this.c;var D=new C();this.c.apply(D,arguments);return D},defaultClassFunctionBody:function(){var B=function(){this.initialize.apply(this,arguments)};joose.addToString(B,function(){return this.meta.className()});return B},addToString:function(){this.addMethod("toString",function(){if(this.stringify){return this.stringify()}return"a "+this.meta.className()})},addInitializer:function(){if(!this.c.prototype.initialize){this.addMethod("initialize",this.initializer())}},initializer:function(){return function B(I){var A=this;if(this.meta.isAbstract){var J=this.meta.className();throw""+J+" is an abstract class and may not instantiated."}var K=this.meta.getAttributes();for(var H in K){if(K.hasOwnProperty(H)){var L=K[H];L.doInitialization(A,I)}}}},dieIfString:function(B){if(Joose.S.isString(B)){throw new TypeError("Parameter must not be a string.")}},addRole:function(C){this.dieIfString(C);var D=this.getClassObject();if(C.meta.apply(D)){this.roles.push(C);this.myRoles.push(C)}},getClassObject:function(){return this.c},classNameToClassObject:function(J){var H=joose.top;var I=J.split(".");var L=H;for(var K=0;K<I.length;K++){var G=I[K];L=L[G];if(!L){throw"Unable to find class "+J}}return L},addNonJooseSuperClass:function(G,H){var F=new Joose.MetaClassBootstrap();F.builder=Joose.MetaClassBootstrap;var E=F.createClass(G);Joose.O.each(H,function(A,B){if(typeof(A)=="function"){E.meta.addMethod(B,A)}else{E.meta.addAttribute(B,{init:A})}});this.addSuperClass(E)},addSuperClass:function(P){this.dieIfString(P);var N=this;var O=P.meta.getMethodNames();for(var R=0;R<O.length;R++){var L=O[R];var K=P.meta.getMethodObject(L);if(K){var M=K.copy();M.setIsFromSuperClass(true);N.addMethodObject(M)}K=P.meta.getClassMethodObject(L);if(K){var M=K.copy();M.setIsFromSuperClass(true);N.addMethodObject(M)}}Joose.O.eachSafe(P.meta.attributes,function(B,A){N.addAttribute(A,B.getProps())});var Q=P.meta.roles;for(var R=0;R<Q.length;R++){var J=Q[R];N.roles.push(J)}this.parentClasses.unshift(P)},_fixMetaclassIncompatability:function(H){var F=H.meta;var I=F.meta.className();if(I=="Joose.Class"||I=="Joose.MetaClass"||I=="Joose.MetaClassBootstrap"){return}if(this.meta.meta.isa(F)){return}var G=F.meta.instantiate(this);for(var J in G){this[J]=G[J]}},isa:function(F){this.dieIfString(F);var E=F.meta.className();if(this.className()==E){return true}for(var H=0;H<this.parentClasses.length;H++){var G=this.parentClasses[H].meta;if(G.className()==E){return true}if(G.isa(F)){return true}}return false},wrapMethod:function(J,H,I,F){var G=this.getMethodObject(J);if(G){this.addMethodObject(G[H](I))}else{if(F){F()}else{throw new Error("Unable to apply "+H+" method modifier because method "+J+" does not exist")}}},dispatch:function(B){return this.getMethodObject(B).asFunction()},hasMethod:function(B){return this.methods[B]!=null||this.classMethods[B]!=null},addMethod:function(H,F,G){var E=new Joose.Method(H,F,G);this.addMethodObject(E)},addClassMethod:function(H,F,G){var E=new Joose.ClassMethod(H,F,G);this.addMethodObject(E)},addMethodObject:function(E){var D=E;var F=D.getName();if(!this.methods[F]&&!this.classMethods[F]){this.methodNames.push(F)}if(D.isClassMethod()){this.classMethods[F]=D}else{this.methods[F]=D}E.addToClass(this.c)},attributeMetaclass:function(){return Joose.Attribute},addAttribute:function(H,G){var F=this.attributeMetaclass();if(G&&G.metaclass){F=G.metaclass}var E=new F(H,G);E.apply(this.c)},getAttributes:function(){return this.attributes},getAttribute:function(B){return this.attributes[B]},setAttribute:function(C,D){return this.attributes[C]=D},getMethodObject:function(B){return this.methods[B]},getClassMethodObject:function(B){return this.classMethods[B]},getAttributeNames:function(){return this.attributeNames},getInstanceMethods:function(){var B=[];Joose.O.eachSafe(this.methods,function(A){B.push(A)});return B},getClassMethods:function(){var B=[];Joose.O.eachSafe(this.classMethods,function(A){B.push(A)});return B},getSuperClasses:function(){return this.parentClasses},getSuperClass:function(){return this.parentClasses[0]},getRoles:function(){return this.roles},getMethodNames:function(){return this.methodNames},makeAnonSubclass:function(){var B=this.createClass(this.className()+"__anon__"+joose.anonymouseClassCounter++);B.meta.addSuperClass(this.getClassObject());return B},addDetacher:function(){this.addMethod("detach",function B(){var E=this.meta;if(E.isDetached){return}var A=E.makeAnonSubclass();A.meta.isDetached=true;this.meta=A.meta;this.constructor=A;var F;if(!this.__proto__){F=this}else{F={};Joose.copyObject(this,F)}A.prototype=F;this.__proto__=A.prototype;return})},validateClass:function(){var E=this.getClassObject();var F=this;var D=true;Joose.A.each(this.roles,function(A){A.meta.isImplementedBy(E,D)})},can:function(C){var D=this.methods[C];if(!D){return false}return true},classCan:function(C){var D=this.classMethods[C];if(!D){return false}return true},does:function(D){for(var C=0;C<this.roles.length;C++){if(D===this.roles[C]){return true}}for(var C=0;C<this.roles.length;C++){if(this.roles[C].meta.does(D)){return true}}return false},implementsMyMethods:function(D){var C=true;Joose.A.each(this.getMethodNames(),function(A){var B=D.meta.can(A);if(!B){C=false}});return C},handleProprequires:function(C){var D=this;if(!this.meta.isa(Joose.Role)){throw ("Keyword 'requires' only available classes with a meta class of type Joose.Role")}if(C instanceof Array){Joose.A.each(C,function(A){D.addRequirement(A)})}else{D.addRequirement(C)}},handlePropisAbstract:function(B){this.isAbstract=B},handlePropisa:function(B){this.addSuperClass(B)},handlePropdoes:function(D){var C=this;if(D instanceof Array){Joose.A.each(D,function(A){C.addRole(A)})}else{C.addRole(D)}},handleProphas:function(F){var G=this;if(typeof F=="string"){var E=arguments[0];var H=arguments[1];G.addAttribute(E,H)}else{Joose.O.eachSafe(F,function(A,B){G.addAttribute(B,A)})}},handlePropmethod:function(D,E,F){this.addMethod(D,E,F)},handlePropmethods:function(D){var C=this;Joose.O.eachSafe(D,function(A,B){C.addMethod(B,A)})},handlePropclassMethods:function(D){var C=this;Joose.O.eachSafe(D,function(B,A){C.addMethodObject(new Joose.ClassMethod(A,B))})},handlePropworkers:function(D){var C=this;Joose.O.eachSafe(D,function(A,B){C.addWorker(B,A)})},handlePropbefore:function(D){var C=this;Joose.O.eachSafe(D,function(A,B){C.wrapMethod(B,"before",A)})},handlePropafter:function(D){var C=this;Joose.O.eachSafe(D,function(A,B){C.wrapMethod(B,"after",A)})},handleProparound:function(D){var C=this;Joose.O.eachSafe(D,function(A,B){C.wrapMethod(B,"around",A)})},handlePropoverride:function(D){var C=this;Joose.O.eachSafe(D,function(A,B){C.wrapMethod(B,"override",A)})},handlePropaugment:function(D){var C=this;Joose.O.eachSafe(D,function(A,B){C.wrapMethod(B,"augment",A,function(){C.addMethod(B,A)})})},handlePropdecorates:function(D){var C=this;Joose.O.eachSafe(D,function(A,B){C.decorate(A,B)})}};Joose.Attribute=function(C,D){this.initialize(C,D)};Joose.Attribute.prototype={_name:null,_props:null,getName:function(){return this._name},getProps:function(){return this._props},initialize:function(C,D){this._name=C;this.setProps(D)},setProps:function(B){if(B){this._props=B}else{this._props={}}},getIsa:function(){var B=this.getProps();if(B.isa){if(!B.isa.meta){return B.isa()}return B.isa}return},addSetter:function(R){var P=R.meta;var N=this.getName();var Q=this.getProps();var S=this.getIsa();var L;if(S){if(!S.meta){throw new Error("Isa declarations in attribute declarations must be Joose classes, roles or type constraints")}var O=false;var K=false;if(Joose.Role&&S.meta.meta.isa(Joose.Role)){O=true}else{if(Joose.TypeConstraint&&S.meta.isa(Joose.TypeConstraint)){K=true}}L=function M(C,F){var E=C;try{if(Q.nullable===true&&E==undefined){}else{if(K){var A=null;if(Q.coerce){A=S.coerce(E)}if(A==null&&Q.nullable!==true){S.validate(E)}else{E=A}}else{if(!E||!E.meta){throw new ReferenceError("The attribute "+N+" only accepts values that have a meta object.")}var B=O?E.meta.does(S):E.meta.isa(S);if(!B){throw new ReferenceError("The attribute "+N+" only accepts values that are objects of type "+S.meta.className()+".")}}}}catch(D){if(F){F.call(this,D,S)}else{throw D}}this[N]=E;return this}}else{L=function T(A){this[N]=A;return this}}P.addMethod(this.setterName(),L)},addGetter:function(M){var K=M.meta;var P=this.getName();var O=this.getProps();var N=function I(){return this[P]};var J=O.init;if(O.lazy){N=function L(){var A=this[P];if(typeof A=="function"&&A===J){this[P]=A.apply(this)}return this[P]}}K.addMethod(this.getterName(),N)},initializerName:function(){return this.toPublicName()},getterName:function(){if(this.__getterNameCache){return this.__getterNameCache}this.__getterNameCache="get"+Joose.S.uppercaseFirst(this.toPublicName());return this.__getterNameCache},setterName:function(){if(this.__setterNameCache){return this.__setterNameCache}this.__setterNameCache="set"+Joose.S.uppercaseFirst(this.toPublicName());return this.__setterNameCache},isPrivate:function(){return this.getName().charAt(0)=="_"},toPublicName:function(){if(this.__publicNameCache){return this.__publicNameCache}var B=this.getName();if(this.isPrivate()){this.__publicNameCache=B.substr(1);return this.__publicNameCache}this.__publicNameCache=B;return this.__publicNameCache},handleIs:function(H){var G=H.meta;var F=this.getName();var J=this.getProps();var I=J.is;if(I=="rw"||I=="ro"){this.addGetter(H)}if(I=="rw"){this.addSetter(H)}},handleInit:function(H){var I=this.getProps();var F=this.getName();H.prototype[F]=null;if(typeof I.init!="undefined"){var G=I.init;var J=typeof G;H.prototype[F]=G}},handleProps:function(B){this.handleIs(B);this.handleInit(B)},apply:function(F){var E=F.meta;var D=this.getName();this.handleProps(F);E.attributeNames.push(D);E.setAttribute(D,this);E.attributes[D]=this}};Joose.Method=function(D,E,F){this.initialize(D,E,F)};Joose.Method.prototype={_name:null,_body:null,_props:null,_isFromSuperClass:false,getName:function(){return this._name},getBody:function(){return this._body},getProps:function(){return this._props},isFromSuperClass:function(){return this._isFromSuperClass},setIsFromSuperClass:function(B){this._isFromSuperClass=B},copy:function(){return new Joose.Method(this.getName(),this.getBody(),this.getProps())},initialize:function(D,E,F){this._name=D;this._body=E;this._props=F;E.name=D;E.meta=this},isClassMethod:function(){return false},apply:function(C,D){return this._body.apply(C,D)},addToClass:function(B){B.prototype[this.getName()]=this.asFunction()},asFunction:function(){return this._body}};Joose.bootstrap();Joose.Builder=function(){this.globalize=function(){Joose.O.each(Joose.Builder.Globals,function(E,D){var F="Joose"+D;if(typeof joose.top[D]=="undefined"){joose.top[D]=E}joose.top[F]=E})}};Joose.Builder.Globals={Module:function(D,C){return Joose.Module.setup(D,C)},Role:function(C,D){if(!D.meta){D.meta=Joose.Role}return JooseClass(C,D)},Prototype:function(C,D){if(!D.meta){D.meta=Joose.Prototype}return JooseClass(C,D)},Class:function(N,R){var S=null;if(N){var T=N;if(joose.currentModule){T=joose.currentModule.getName()+"."+N}var Q=joose.top;var L=T.split(".");for(var K=0;K<L.length;K++){Q=Q[L[K]]}S=Q}if(S==null){var P;if(R&&R.meta){P=R.meta;delete R.meta}else{if(R&&R.isa&&R.isa!=Joose.Class){P=R.isa.meta.builder}else{P=Joose.Class}}var O=new P();O.builder=P;var S=O.createClass(N,null,joose.currentModule);S.meta.builder=P;var T=S.meta.className();if(N&&T){var Q=joose.top;var M=new String(T);var L=M.split(".");for(var K=0;K<L.length-1;K++){if(Q[L[K]]==null){Q[L[K]]={}}Q=Q[L[K]]}Q[L[L.length-1]]=S}}S.meta.initializeFromProps(R);return S},Type:function(H,F){var G=Joose.TypeConstraint.newFromTypeBuilder(H,F);var E=joose.currentModule;if(!E){JooseModule("TYPE");E=TYPE.meta}E.addElement(G);E.getContainer()[H]=G;return G},joosify:function(L,K){var J=K;var I=new Joose.Class();I.builder=Joose.Class;J.toString=function(){return this.meta.className()};J=I.createClass(L,J);var M=J.meta;for(var P in K.prototype){if(P=="meta"){continue}var N=K.prototype[P];if(typeof(N)=="function"){M.addMethod(P,N)}else{var O={};if(typeof(N)!="undefined"){O.init=N}M.addAttribute(P,O)}}return J},rw:"rw",ro:"ro"};joose.init();Joose.bootstrap2();(function(B){B("Joose.Method",{methods:{copy:function(){return this.meta.instantiate(this.getName(),this.getBody(),this.getProps())},_makeWrapped:function(A){return this.meta.instantiate(this.getName(),A)},around:function(F){var A=this.getBody();return this._makeWrapped(function E(){var C=this;var D=function(){return A.apply(C,arguments)};return F.apply(this,Joose.A.concat([D],arguments))})},before:function(E){var A=this.getBody();return this._makeWrapped(function F(){E.apply(this,arguments);return A.apply(this,arguments)})},after:function(E){var A=this.getBody();return this._makeWrapped(function F(){var C=A.apply(this,arguments);E.apply(this,arguments);return C})},override:function(E){var A=this.getBody();return this._makeWrapped(function F(){var D=this;var I=function(){return A.apply(D,arguments)};var C=this.SUPER;this.SUPER=I;var J=E.apply(this,arguments);this.SUPER=C;return J})},augment:function(E){var A=this.getBody();A.source=A.toString();return this._makeWrapped(function F(){var C=A;var J=this;var L=E;L.source=L.toString();if(!this.__INNER_STACK__){this.__INNER_STACK__=[]}this.__INNER_STACK__.push(L);var D=this.INNER;this.INNER=function(){return J.__INNER_STACK__.pop().apply(J,arguments)};var K=A.apply(this,arguments);this.INNER=D;return K})}}})})(JooseClass);(function(B){B("Joose.ClassMethod",{isa:Joose.Method,methods:{isClassMethod:function(){return true},addToClass:function(A){A[this.getName()]=this.asFunction()},copy:function(){return new Joose.ClassMethod(this.getName(),this.getBody(),this.getProps())}}})})(JooseClass);(function(B){B("Joose.Attribute",{after:{handleProps:function(A){this.handleHandles(A);this.handlePredicate(A)}},methods:{isPersistent:function(){var A=this.getProps();if(A.persistent==false){return false}return true},doInitialization:function(K,M){var L=this.initializerName();var O=this.getName();var P;var Q=false;if(typeof M!="undefined"&&typeof M[L]!="undefined"){P=M[L];Q=true}else{var R=this.getProps();var N=R.init;if(typeof N=="function"&&!R.lazy){P=N.call(K);Q=true}else{if(R.required){throw"Required initialization parameter missing: "+L+"(While initializing "+K+")"}}}if(Q){var A=this.setterName();if(K.meta.can(A)){K[A](P)}else{K[O]=P}}},handleHandles:function(J){var I=J.meta;var N=this.getName();var L=this.getProps();var M=L.handles;var A=L.isa;if(M){if(M=="*"){if(!A){throw"I need an isa property in order to handle a class"}var K=L.handleWith;I.decorate(A,N,K)}else{throw"Unsupported value for handles: "+M}}},handlePredicate:function(H){var A=H.meta;var J=this.getName();var I=this.getProps();var K=I.predicate;var L=this.getterName();if(K){A.addMethod(K,function(){var C=this[L]();return C?true:false})}}}})})(JooseClass);(function(B){B("Joose.Role",{isa:Joose.Class,has:["requiresMethodNames","methodModifiers","metaRoles"],methods:{wrapMethod:function(I,G,H,J){this.methodModifiers.push(arguments);var A=this.methodModifiers},requiresMethod:function(A){var D=false;Joose.A.each(this.requiresMethodNames,function(C){if(A==C){D=true}});return D},addInitializer:Joose.emptyFunction,defaultClassFunctionBody:function(){var A=function(){throw new Error("Roles may not be instantiated.")};joose.addToString(A,function(){return this.meta.className()});return A},addSuperClass:function(){throw new Error("Roles may not inherit from a super class.")},initialize:function(){this._name="Joose.Role";this.requiresMethodNames=[];this.methodModifiers=[]},addRequirement:function(A){this.requiresMethodNames.push(A)},unapply:function(K){if(!joose.isInstance(K)){throw new Error("You way only remove roles from instances.")}if(!K.meta.isDetached){throw new Error("You may only remove roles that were applied at runtime")}var A=this.getClassObject();var Q=K.meta.myRoles;var M=false;var L=[];for(var R=0;R<Q.length;R++){if(Q[R]===A){M=true}else{L.push(Q[R])}}if(!M){throw new Error("The role "+this.className()+" was not applied to the object at runtime")}var N=K.meta.getSuperClass();var O=N.meta.makeAnonSubclass();var P=new O();for(var R=0;R<L.length;R++){var A=L[R];O.meta.addRole(A)}O.prototype=P;K.meta=O.meta;K.constructor=O;K.__proto__=P},addMethodToClass:function(A,G){var H=A.getName();var F;if(A.isClassMethod()){F=G.meta.getClassMethodObject(H)}else{F=G.meta.getMethodObject(H)}if(!F||F.isFromSuperClass()){G.meta.addMethodObject(A)}},apply:function(J){if(J.meta.does(this.getClassObject())){return false}if(joose.isInstance(J)){J.detach();J.meta.addRole(this.getClassObject());this.applyMethodModifiers(J);var K=true;this.isImplementedBy(J,K)}else{var I=this;var H=this.getMethodNames();Joose.A.each(H,function A(C){var D=I.getMethodObject(C);if(D){I.addMethodToClass(D,J)}D=I.getClassMethodObject(C);if(D){I.addMethodToClass(D,J)}});if(this.metaRoles){Joose.A.each(this.metaRoles,function L(C){C.meta.apply(J.meta)})}}return true},applyMethodModifiers:function(D){Joose.A.each(this.methodModifiers,function A(C){D.meta.wrapMethod.apply(D.meta,C)})},hasRequiredMethods:function(A,G){var F=this;var H=true;Joose.A.each(this.requiresMethodNames,function(C){var D=A.meta.can(C);if(!D){if(G){throw ("Class "+A.meta.className()+" does not fully implement the role "+F.className()+". The method is "+C+" missing.")}H=false;return}});return H},isImplementedBy:function(A,E){var F=this.hasRequiredMethods(A,E);if(F){F=this.implementsMyMethods(A)}return F},handlePropmetaRoles:function(A){this.metaRoles=A}}});Joose.Role.anonymousClassCounter=0})(JooseClass);(function(B){B("Joose.SimpleRequest",{has:{_req:{}},methods:{initialize:function(){if(window.XMLHttpRequest){this._req=new XMLHttpRequest()}else{this._req=new ActiveXObject("Microsoft.XMLHTTP")}},getText:function(D){this._req.open("GET",D,false);try{this._req.send(null);if(this._req.status==200||this._req.status==0){return this._req.responseText}}catch(A){throw ("File not found: "+D);return null}throw ("File not found: "+D);return null}}})})(JooseClass);(function(B){B("Joose.Gears",{isa:Joose.Class,has:{wp:{},calls:{init:{}},callIndex:{init:0}},methods:{initialize:function(){JooseGearsInitializeGears();if(this.canGears()){this.wp=google.gears.factory.create("beta.workerpool");var A=this;this.wp.onmessage=function(G,H,F){A.handleGearsMessage(F)}}},handleGearsMessage:function(G){var H=G.body;var A=H.to;var I=H.ret;var J=this.calls[H.index];if(J.meta.can(A)){J[A].call(J,I)}},canGears:function(){return window.google&&window.google.gears&&window.google.gears.factory},addWorker:function(N,A,T){var X="on"+Joose.S.uppercaseFirst(N);var Q=this.meta.getClassObject().ajaxRequest;if(!this.canGears()){var S=function(){var C=this;var D={sendReturn:function(G,F){if(C.meta.can(F)){C[F].call(C,G)}},clientHasGears:function(){return false},ajaxRequest:Q};var E=A.apply(D,arguments);D.sendReturn(E,X)};this.addMethod(N,S,T);return}var V=this.can("jsonURL")?this.c.jsonURL():"json2.js";var P=new Joose.SimpleRequest().getText(V);var O="var timer = google.gears.factory.create('beta.timer');\nfunction aClass () {}; aClass.prototype."+N+" = "+A.toString()+"\n\naClass.prototype.clientHasGears = function () { return true }\naClass.prototype.ajaxRequest = "+Q.toString()+"\n\nvar wp = google.gears.workerPool;\nwp.onmessage = function (a,b,message) {\nvar paras = message.body;\nvar o = new aClass();\no.sendReturn = function (ret, cbName) { wp.sendMessage({ ret: ret, to: cbName, index: paras.index }, message.sender) } \nvar ret = o."+N+".apply(o, paras.args); if(!ret) ret = null; \no.sendReturn(ret, paras.cbName);\n}\n\n";O+=P;var R=this.wp;var W=R.createWorker(O);var U=this;var S=function(){var E=[];for(var D=0;D<arguments.length;D++){E.push(arguments[D])}var C={args:E,cbName:X,index:U.callIndex};R.sendMessage(C,W);U.calls[U.callIndex]=this;U.callIndex++};this.addMethod(N,S,T)}},classMethods:{setupGearsCompat:function(){window.timer={setTimeout:function(D,A){return window.setTimeout(D,A)},setInterval:function(D,A){return window.setInterval(D,A)},clearTimeout:function(A){return window.clearTimeout(A)},clearInterval:function(A){return window.clearInterval(A)}}},clientHasGears:function(){return window.google&&window.google.gears&&window.google.gears.factory},ajaxRequest:function(M,L,S,N,Q){var T;if(this.clientHasGears()){T=google.gears.factory.create("beta.httprequest")}else{T=window.ActiveXObject?new ActiveXObject("Microsoft.XMLHTTP"):new XMLHttpRequest()}var P="";if(S){for(var R in S){P+=encodeURIComponent(R)+"="+encodeURIComponent(S[R])+"&"}}var A=L;if(S&&M=="GET"){A+="?"+P}T.open(M,A,true);T.onreadystatechange=function O(){if(T.readyState==4){if(T.status>=200&&T.status<400){var C=T.responseText;N(C)}else{if(Q){return Q(T)}else{throw new Error("Error fetching url "+A+". Response code: "+T.status+" Response text: "+T.responseText)}}}};if(S&&M=="POST"){T.setRequestHeader("Content-Type","application/x-www-form-urlencoded; charset=UTF-8");T.send(P)}else{P="";T.send(P)}}}})})(JooseClass);function JooseGearsInitializeGears(){if(window.google&&google.gears){return}var C=null;if(typeof GearsFactory!="undefined"){C=new GearsFactory()}else{try{C=new ActiveXObject("Gears.Factory");if(C.getBuildInfo().indexOf("ie_mobile")!=-1){C.privateSetGlobalObject(this)}}catch(D){if(navigator.mimeTypes["application/x-googlegears"]){C=document.createElement("object");C.style.display="none";C.width=0;C.height=0;C.type="application/x-googlegears";document.documentElement.appendChild(C)}}}if(!C){return}if(!window.google){google={}}if(!google.gears){google.gears={factory:C}}}(function(C,D){D("Joose.Storage",{methods:{toJSON:function(){return this.pack(Joose.Storage.TEMP_SEEN)},identity:function(){if(this.__ID__){return this.__ID__}else{return this.__ID__=Joose.Storage.OBJECT_COUNTER++}},pack:function(A){return this.meta.c.storageEngine().pack(this,A)}},classMethods:{storageEngine:function(){return Joose.Storage.Engine},unpack:function(A){return this.storageEngine().unpack(this,A)}}});D("Joose.Storage.jsonpickle",{does:Joose.Storage,classMethods:{storageEngine:function(){return Joose.Storage.Engine.jsonpickle}}});Joose.Storage.OBJECT_COUNTER=1;C("Joose.Storage.Engine",{classMethods:{pack:function(L,N){if(N){var A=L.identity();var J=N[A];if(J){return{__ID__:A}}}if(L.meta.can("prepareStorage")){L.prepareStorage()}if(N){N[L.identity()]=true}var B={__CLASS__:this.packedClassName(L),__ID__:L.identity()};var M=L.meta.getAttributes();Joose.O.eachSafe(M,function K(F,E){if(F.isPersistent()){B[E]=L[E]}});return B},unpack:function(J,K){var B=J.meta;var L=B.instantiate();var I=false;Joose.O.eachSafe(K,function A(E,G){if(G=="__CLASS__"){var F=Joose.Storage.Unpacker.packedClassNameToJSClassName(E);if(F!=L.meta.className()){throw new Error("Storage data is of wrong type "+F+". I am "+L.meta.className()+".")}I=true;return}L[G]=E});if(!I){throw new Error("Serialized data needs to include a __CLASS__ attribute.: "+K)}delete L.__ID__;if(L.meta.can("finishUnpack")){L.finishUnpack()}return L},packedClassName:function(B){if(B.meta.can("packedClassName")){return B.packedClassName()}var F=B.meta.className();var A=F.split(".");return A.join("::")}}});C("Joose.Storage.Engine.jsonpickle",{classMethods:{pack:function(L,N){if(N){var A=L.identity();var J=N[A];if(J){return{objectid__:A}}}if(L.meta.can("prepareStorage")){L.prepareStorage()}if(N){N[L.identity()]=true}var B={classname__:this.packedClassName(L),classmodule__:this.packedModuleName(L),objectid__:L.identity()};var M=L.meta.getAttributes();Joose.O.eachSafe(M,function K(F,E){if(F.isPersistent()){B[E]=L[E]}});return B},unpack:function(J,K){var B=J.meta;var L=B.instantiate();var I=false;Joose.O.eachSafe(K,function A(E,H){if(H=="classname__"){var F=E;var G=K.classmodule__;if(G){F=""+G+"."+E}if(F!=L.meta.className()){throw new Error("Storage data is of wrong type "+F+". I am "+L.meta.className()+".")}I=true;return}if(H=="classmodule__"){return}L[H]=E});if(!I){throw new Error("Serialized data needs to include a __CLASS__ attribute.: "+K)}if(L.meta.can("finishUnpack")){L.finishUnpack()}return L},packedClassName:function(B){var F=B.meta.className();var A=F.split(".");return A.pop()},packedModuleName:function(B){var F=B.meta.className();var A=F.split(".");A.pop();return A.join(".")}}});Joose.Storage.storageEngine=Joose.Storage.Engine;Joose.Storage.jsonpickle.storageEngine=Joose.Storage.Engine.jsonpickle})(JooseClass,JooseRole);(function(B){B("Joose.Storage.Unpacker",{classMethods:{unpack:function(J){var K=J.__CLASS__;if(!K){throw ("Serialized data needs to include a __CLASS__ attribute.")}var L=this.packedClassNameToJSClassName(K);var H=this.meta.classNameToClassObject(L);var I=H.unpack(J);var A;if(Joose.Storage.CACHE&&(A=J.__ID__)){Joose.Storage.CACHE[A]=I}return I},packedClassNameToJSClassName:function(D){var A=D.split("-");A=A[0].split("::");return A.join(".")},jsonParseFilter:function(D,A){if(A!=null&&typeof A=="object"){if(A.__CLASS__){return Joose.Storage.Unpacker.unpack(A)}if(A.__ID__){return Joose.Storage.CACHE[A.__ID__]}}return A},patchJSON:function(){var A=JSON.parse;var F=this.jsonParseFilter;JSON.parse=function(C,D){Joose.Storage.CACHE={};return A(C,function H(L,K){var G=K;if(D){G=D(L,K)}return F(L,G)})};var E=JSON.stringify;JSON.stringify=function(){Joose.Storage.TEMP_SEEN={};return E.apply(JSON,arguments)}}}});B("Joose.Storage.Unpacker.jsonpickle",{isa:Joose.Storage.Unpacker,classMethods:{unpack:function(J){var K=J.classname__;if(!K){throw ("Serialized data needs to include a classname__ attribute.")}var L=this.packedClassNameToJSClassName(K,J.classmodule__);var H=this.meta.classNameToClassObject(L);var I=H.unpack(J);var A;if(Joose.Storage.CACHE&&(A=J.objectid__)){Joose.Storage.CACHE[A]=I}return I},packedClassNameToJSClassName:function(A,E){var F="";if(E){F+=E+"."}F+=A;return F},jsonParseFilter:function(D,A){if(A!=null&&typeof A=="object"){if(A.classname__){return Joose.Storage.Unpacker.jsonpickle.unpack(A)}if(A.objectid__){return Joose.Storage.CACHE[A.objectid__]}}return A}}})})(JooseClass);(function(B){B("Joose.Decorator",{meta:Joose.Role,methods:{decorate:function(A,H,I){var G=this;var J=A.meta.getInstanceMethods();Joose.A.each(J,function(F){var E=F.getName();var C=H;if(!G.can(E)){var D=function(){var L=this[C];return L[E].apply(L,arguments)};if(I){D=I(E)}G.addMethod(E,D)}})}}});Joose.Decorator.meta.apply(Joose.Class)})(JooseClass);(function(B){B("Joose.Module",{has:{_name:{is:"rw"},_elements:{is:"rw"},_container:{is:"rw"}},classMethods:{setup:function(N,M){var Q=this;var T=N.split(".");var U=joose.top;var R=[];var V;for(var S=0;S<T.length;S++){var A=T[S];if(A=="meta"){throw"Module names may not include a part called 'meta'."}var O=U[A];R.push(A);var N=R.join(".");if(typeof O=="undefined"){U[A]={};V=new Joose.Module(N);V.setContainer(U[A]);U[A].meta=V;Joose.Module._allModules.push(U[A])}else{V=O.meta;if(!(V&&V.meta&&(V.meta.isa(Joose.Module)))){throw"Trying to setup module "+N+" failed. There is already something else: "+V}}U=U[A]}var P=joose.currentModule;joose.currentModule=V;if(M){M(U)}joose.currentModule=P;return U},getAllModules:function(){return this._allModules}},methods:{alias:function(D){var A=this;if(arguments.length==0){return this}Joose.A.each(this.getElements(),function(F){var C=A.globalName(F.meta.className());if(D[C]===F){return}if(typeof D[C]!="undefined"){throw"There is already something else in the spot "+C}D[C]=F})},globalName:function(E){var F=this.getName();if(E.indexOf(F)!=0){throw"All things inside me should have a name that starts with "+F+". Name is "+E}var A=E.substr(F.length+1);if(A.indexOf(".")!=-1){throw"The things inside me should have no more dots in there name. Name is "+A}return A},removeGlobalSymbols:function(){Joose.A.each(this.getElements(),function(D){var A=this.globalName(D.getName());delete joose.top[A]})},initialize:function(A){this.setElements([]);this.setName(A)},isEmpty:function(){return this.getElements().length==0},addElement:function(A){if(!(A||A.meta)){throw"You may only add things that are Joose objects"}this._elements.push(A)},getNames:function(){var A=[];Joose.A.each(this.getElements(),function(D){A.push(D.meta.getName())});return A}}})})(JooseClass);__global__={};__global__.meta=new Joose.Module();__global__.meta.setName("__global__");__global__.meta.setContainer(__global__);Joose.Module._allModules=[__global__];JooseModule("__global__.nomodule",function(){});__global__.nomodule.meta._elements=joose.globalObjects;(function(B){B("Joose.Prototype",{isa:Joose.Class,override:{initializer:function(){var A=this.SUPER();return function(){A.apply(this,arguments);var D=this.meta;this.meta=new Joose.PrototypeLazyMetaObjectProxy();this.meta.metaObject=D;this.meta.object=this}}}});B("Joose.PrototypeLazyMetaObjectProxy",{has:{metaObject:{is:"rw",isa:Joose.Class,handles:"*",handleWith:function(A){return function(){var D=this.object;D.meta=this.metaObject;D.detach();D.meta[A].apply(D.meta,arguments)}}},object:{is:"rw"}}});Joose.bootstrap3()})(JooseClass);(function(B){B("Joose.TypeConstraint",{has:{_constraints:{is:"ro",init:function(){return[]}},_coercions:{is:"ro",init:function(){return[]}},_messages:{is:"ro",init:function(){return[]}},_callback:{is:"ro",init:function(){return function(A){throw new ReferenceError(A)}}},_name:{is:"ro"},_uses:{is:"ro"},props:{is:"rw"}},classMethods:{newFromTypeBuilder:function(I,A){var G=new Joose.TypeConstraint({name:I});if(A.uses&&typeof A.uses.meta!="undefined"&&A.uses.meta.isa(Joose.TypeConstraint)){G._uses=A.uses}if(A.where){G.addConstraint(A.where,A.message)}G.setProps(A);if(A.coerce){for(var H=0;H<A.coerce.length;H++){var J=A.coerce[H];G.addCoercion(new Joose.TypeCoercion({from:J.from,via:J.via}))}}return G}},methods:{stringify:function(){return this._name},makeSubType:function(D){var A=new Joose.TypeConstraint({name:D});Joose.A.each(this._constraints,function(C){A.addConstraint(C)});return A},addCoercion:function(A){this._coercions.push(A)},addConstraint:function(A,D){this._constraints.push(A);this._messages.push(D)},getConstraintList:function(){var D=this._constraints;if(this._uses){var A=this._uses.getConstraintList();return A.concat(D)}return D},getMessageList:function(){var A=this._messages;if(this._uses){var D=this._uses.getMessageList();return D.concat(A)}return A},validateBool:function(A){var D=this._validate(A);if(D==-1){return true}return false},validate:function(A){var H=this._validate(A);if(H==-1){return true}var F=this.getMessageList();var G=F[H]?F[H].call(this,A):"The passed value ["+A+"] is not a "+this;this._callback(G)},_validate:function(A){var J=this.getConstraintList();var I,K;for(I=0,K=J.length;I<K;I++){var H=J[I];var L=false;if(H instanceof RegExp){L=H.test(A)}else{L=H.call(this,A)}if(!L){return I}}return -1},coerce:function(A){if(this.validateBool(A)){return A}var H=this._coercions;for(var I=0,K=H.length;I<K;I++){var J=H[I];var L=J.coerce(A);if(L!==null){return L}}return null}}})})(JooseClass);(function(D,C){C("CoercionFrom",{where:function(A){if(A.meta&&A.meta.isa(Joose.TypeConstraint)){return true}return false}});D("Joose.TypeCoercion",{has:{_from:{isa:TYPE.CoercionFrom,is:"rw"},_via:{is:"rw"}},methods:{coerce:function(A){if(this._from.validateBool(A)){return this._via(A)}return null}}})})(JooseClass,JooseType);(function(B){B("Any",{where:function(A){return true}});B("Null",{uses:TYPE.Any,where:function(A){if(A===null){return true}return false}});B("NotNull",{uses:TYPE.Any,where:function(A){if(A===null){return false}return true}});B("Enum",{uses:TYPE.NotNull,message:function(A){return"The passed value ["+A+"] is not "+(this.getProps().strictMatch?"*strictly* ":"")+"one of ["+this.getProps().values.join(",")+"]"},where:function(A){var E=this;if(!E.getProps()||E.getProps().values===undefined||!(E.getProps().values instanceof Array)){throw"Enum Type needs Array of values in 'values' property of Type declaration"}var F=function(C){if(E.getProps().strictMatch===true){return(C===A)}return(C==A)};if(Joose.A.grep(E.getProps().values,F).length!=0){return true}return false}});B("Obj",{uses:TYPE.NotNull,where:function(A){if(A instanceof Object){return true}return false}});B("Str",{uses:TYPE.NotNull,where:function(A){if(typeof A=="string"||A instanceof String){return true}return false},coerce:[{from:TYPE.Any,via:function(A){if(A==null){return""}else{return""+A}}}]});B("Num",{uses:TYPE.NotNull,where:function(A){if(typeof A=="number"||A instanceof Number){return true}return false},coerce:[{from:TYPE.Str,via:function(A){if(A==null||A==""){return undefined}return parseFloat(A)}}]});B("Bool",{uses:TYPE.NotNull,where:function(A){if(A===true||A===false){return true}return false},coerce:[{from:TYPE.Any,via:function(A){if(A==null||A===""){return undefined}if(A==1||A=="1"||A=="true"){return true}if(A==0||A=="0"||A=="false"){return false}return null}}]});B("Int",{uses:TYPE.Num,where:function(A){var D=String(A);if(D.match(/^\d*\.\d$/)){return false}return true},coerce:[{from:TYPE.Str,via:function(A){if(A==null||A==""){return undefined}if(A.match(/^-{0,1}\d+$/)){return parseInt(A)}return}}]});B("Float",{uses:TYPE.Num,where:function(A){return true}});B("Func",{uses:TYPE.Obj,where:function(A){if(typeof A=="function"){return true}return false}});B("Array",{uses:TYPE.Obj,where:function(A){if(A instanceof Array){return true}return false}});B("Date",{uses:TYPE.Obj,where:function(A){if(A instanceof Date){return true}return false},coerce:[{from:TYPE.Str,via:function(A){var D;if(A==undefined||A==""){return undefined}else{if(D=A.match(/\s*(\d+)-(\d+)-(\d+)/)){return new Date(D[1],D[2]-1,[D[3]])}}return null}}]});B("Joose",{uses:TYPE.Obj,where:function(A){if(A.meta&&A.meta.meta.isa(Joose.Class)){return true}return false}})})(JooseType);if(!this.JSON){JSON=function(){function f(n){return n<10?"0"+n:n}Date.prototype.toJSON=function(key){return this.getUTCFullYear()+"-"+f(this.getUTCMonth()+1)+"-"+f(this.getUTCDate())+"T"+f(this.getUTCHours())+":"+f(this.getUTCMinutes())+":"+f(this.getUTCSeconds())+"Z"};var cx=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,escapeable=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,gap,indent,meta={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},rep;function quote(string){escapeable.lastIndex=0;return escapeable.test(string)?'"'+string.replace(escapeable,function(a){var c=meta[a];if(typeof c==="string"){return c}return"\\u"+("0000"+(+(a.charCodeAt(0))).toString(16)).slice(-4)})+'"':'"'+string+'"'}function str(key,holder){var i,k,v,length,mind=gap,partial,value=holder[key];if(value&&typeof value==="object"&&typeof value.toJSON==="function"){value=value.toJSON(key)}if(typeof rep==="function"){value=rep.call(holder,key,value)}switch(typeof value){case"string":return quote(value);case"number":return isFinite(value)?String(value):"null";case"boolean":case"null":return String(value);case"object":if(!value){return"null"}gap+=indent;partial=[];if(typeof value.length==="number"&&!(value.propertyIsEnumerable("length"))){length=value.length;for(i=0;i<length;i+=1){partial[i]=str(i,value)||"null"}v=partial.length===0?"[]":gap?"[\n"+gap+partial.join(",\n"+gap)+"\n"+mind+"]":"["+partial.join(",")+"]";gap=mind;return v}if(rep&&typeof rep==="object"){length=rep.length;for(i=0;i<length;i+=1){k=rep[i];if(typeof k==="string"){v=str(k,value,rep);if(v){partial.push(quote(k)+(gap?": ":":")+v)}}}}else{for(k in value){if(Object.hasOwnProperty.call(value,k)){v=str(k,value,rep);if(v){partial.push(quote(k)+(gap?": ":":")+v)}}}}v=partial.length===0?"{}":gap?"{\n"+gap+partial.join(",\n"+gap)+"\n"+mind+"}":"{"+partial.join(",")+"}";gap=mind;return v}}return{stringify:function(value,replacer,space){var i;gap="";indent="";if(typeof space==="number"){for(i=0;i<space;i+=1){indent+=" "}}else{if(typeof space==="string"){indent=space}}rep=replacer;if(replacer&&typeof replacer!=="function"&&(typeof replacer!=="object"||typeof replacer.length!=="number")){throw new Error("JSON.stringify")}return str("",{"":value})},parse:function(text,reviver){var j;function walk(holder,key){var k,v,value=holder[key];if(value&&typeof value==="object"){for(k in value){if(Object.hasOwnProperty.call(value,k)){v=walk(value,k);if(v!==undefined){value[k]=v}else{delete value[k]}}}}return reviver.call(holder,key,value)}cx.lastIndex=0;if(cx.test(text)){text=text.replace(cx,function(a){return"\\u"+("0000"+(+(a.charCodeAt(0))).toString(16)).slice(-4)})}if(/^[\],:{}\s]*$/.test(text.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,""))){j=eval("("+text+")");return typeof reviver==="function"?walk({"":j},""):j}throw new SyntaxError("JSON.parse")}}}()}String.prototype.html=function(){var A=new String(this);A=A.replace(/\&/g,"&amp;");A=A.replace(/\</g,"&lt;");A=A.replace(/\>/g,"&gt;");A=A.replace(/"/g,"&quot;");A=A.replace(/'/g,"&#39;");return A};String.prototype.decodeHtml=function(){var A=new String(this);A=A.replace(/&lt;/g,"<");A=A.replace(/&gt;/g,">");A=A.replace(/&quot;/g,'"');A=A.replace(/&39;/g,"'");A=A.replace(/&amp;/g,"&");return A};Module("block.ui",function(){Class("Array",{has:{array:{is:"rw",init:function(){return[]}}},methods:{initialize:function(A){this.array=A},each:function(D){var B=this.array;for(var C=0,A=B.length;C<A;C++){D.call(this,B[C])}},call:function(C,B){this.each(function A(D){D[C].apply(D,B)})}}})});function $A(A){return new block.ui.Array(A)}Module("block.ui",function(A){Class("ElementMetaclass",{isa:Joose.Class,methods:{attributeMetaclass:function(){return A.ElementAttributeMetaclass}}});Class("ElementAttributeMetaclass",{isa:Joose.Attribute})});Module("block.ui.role",function(){Role("Notification",{methods:{updated:function(){var B=this.listener;for(var A=0;A<B.length;A++){this.listener[A].notify(this)}},addListener:function(A){this.listener.push(A)},removeListener:function(A){var D=this.listener;var C=[];for(var B=0;B<D.length;B++){if(A!==this.listener[B]){C.push(this.listener[B])}}this.listener=C},notify:function(){}}})});Module("block.ui.role",function(){Role("Draggable",{methods:{makeDraggable:function(){var A=this;this.$.draggable({stop:function(){A.dragComplete()},grid:document.grid.jQueryGridParameter()})},dragComplete:function(){this.updateState();this.redraw()}}})});Module("block.ui.role",function(){Role("Resizable",{requires:["getMinWidth","getMinHeight"],after:{place:function(){this.makeResizable()}},methods:{makeResizable:function(){var B=this;this.resize$().resizable({handles:"all",autoHide:true,proxy:false,minHeight:B.getMinHeight(),minWidth:B.getMinWidth(),aspectRatio:this.maintainAspectRatio()?"preserve":null,stop:function A(){B.onResize()},grid:document.grid.jQueryGridParameter()})},maintainAspectRatio:function(){return document.manager.shiftKeyDown()},resize$:function(){return this.$},onResize:function(){this.updateState()}}})});Module("block.ui.role",function(){Role("Focusable",{after:{place:function(){var B=this;this.$.mousedown(function A(C){C.preventDefault();document.manager.switchFocus(B,C.shiftKey);return false})},focus:function(){this.$.append('<div class="focusDiv"></div>')},blur:function(){this.$.find(".focusDiv").remove()}}})});Module("block.ui.role",function(){Role("Editable",{requires:["getText","setText","_updateStateCore","touch","_updateFromCore","updateState"],after:{place:function(){var A=this;this.$.dblclick(function(){var B=prompt("Please enter Text",A.textContainer().text());if(B){A.text(B);A.updateState()}});A.text(this.getText())},_updateFromCore:function(A){this.text(A.getText().decodeHtml())},_updateStateCore:function(){this.setText(this.textContainer().html())},redraw:function(){this.textContainer().html(this.getText().decodeHtml())}},methods:{text:function(B){if(arguments.length>0){var A=new String(B).html();this.textContainer().html(A)}return this.getText()},textContainer:function(){return this.$.find(".textField")}}})});Module("block.ui.role",function(){Role("ShapeUI",{requires:[],after:{place:function(){var A=this;this.$.contextMenu("ShapeContextMenu",{bindings:{ctDelete:function(){A.destroy()},ctCopy:function(){document.manager.copy(A)},ctBringToFront:function(){A.zIndex(document.manager.nextZIndex())},ctAsGroup:function(){if(!A.meta.isa(block.ui.shape.SelectionGroup)){alert("selection must be selection group");return}var B=A.asRealGroup();document.shapes.addAndDraw(B);document.manager.switchFocus(B)},ctUnGroup:function(){alert("not implemented")}}})}}})});Module("block.ui.role",function(){Role("Group",{does:[block.ui.role.Draggable,block.ui.role.Focusable,block.ui.role.ShapeUI],after:{draw:function(){var E=this;var G=null;var F=null;var D=null;var C=null;Joose.A.each(this.getElements(),function B(J){var L=J.top();if(F==null||L<F){F=L}var K=J.left();if(G==null||K<G){G=K}var H=J.right();if(D==null||H>D){D=H}var I=J.bottom();if(C==null||I>C){C=I}});if(G!=null&&F!=null&&D!=null&&C!=null){this.x(G);this.y(F);this.width(D-G);this.height(C-F);var A=true;this.updateState(A)}}},override:{destroy:function(){document.undo.beginTransaction();Joose.A.each(this.getElements(),function(A){A.destroy()});this.SUPER();document.undo.commit()},touch:function(){Joose.A.each(this.getElements(),function(A){A.touch()});this.SUPER()},updateState:function(A){document.undo.beginTransaction();var E=this.getLeft();var F=this.getTop();this.SUPER();if(!A){var H=this.getLeft();var G=this.getTop();var C=H-E;var B=G-F;if(C==0&&B==0){return}Joose.A.each(this.getElements(),function D(I){I.x(I.left()+C);I.y(I.top()+B);if(I.meta.can("dragComplete")){I.redraw()}I.updateState()})}document.undo.commit()}},methods:{create:function(){return jQuery("<div class='group shape'></div>")},focus:function(){this.$.show()},blur:function(){this.$.hide()}}})});Module("block.ui.role",function(){Role("Stylable",{requires:["getStyle","setStyle"],after:{initialize:function(){if(this.getStyle()==null){this.setStyle({})}},draw:function(){this.drawCSS()},redraw:function(){this.drawCSS()},_updateFromCore:function(A){var B=this.getStyle();this.setStyle(A.getStyle());this.drawCSS(B)}},methods:{drawCSS:function(D){var C=this;var B=this.getStyle();Joose.O.each(B,function A(F,E){if(!D||D[E]!=F){C.css(E,F)}})},css:function(A,B){if(arguments.length>1){this.$.css(A,B);this.$.find(".stylable").css(A,B);this.getStyle()[A]=B}return this.getStyle()[A]}}})});Module("block.ui.role",function(){Role("Connectable",{})});Module("block.ui",function(){var A=0;Class("Guid",{has:{id:{}},methods:{toString:function(){return""+this.id}},classMethods:{startReplaceSession:function(){this.substitution={}},replaceGuids:function(C){var D=this;var B=[C];C.traverse(function(E){B.push(E)});Joose.A.each(B,function(E){var F=C.getGuid();var G=C.resetGuid();D.substitution[F]=G});Joose.A.each(B,function(G){if(G.meta.isa(block.ui.shape.Connection)){var E=D.substitution[G.getOriginGuid()];G.setOriginGuid(E);var F=D.substitution[G.getDestinationGuid()];G.setDestinationGuid(F)}})},create:function(){return document.paras.guidBase+"-"+A++}}})});Module("block.ui",function(){var A;Class("Manager",{has:{_focusElement:{is:"ro"},_zIndex:{is:"rw",init:10},_tempStore:{is:"rw"},currentKeyCode:{is:"rw"},dirty:{is:"rw",init:false},shapeByGuidMap:{is:"rw",init:function(){return{}}}},after:{initialize:function(){var C=this;var D=$(window);D.keydown(function B(F){C.setCurrentKeyCode(F.keyCode)});D.keyup(function E(){C.setCurrentKeyCode(null)})},setDirty:function(){saveMessage("Unsaved")}},methods:{clearFocus:function(){if(A){clearTimeout(A)}if(this._focusElement){this._focusElement.blur()}this._focusElement=null;document.propPanel.hide()},asyncSwitchFocus:function(){if(A){clearTimeout(A)}var C=this;var B=arguments;A=setTimeout(function(){C.switchFocus.apply(C,B)},0)},switchFocus:function(C,B){if(this._focusElement===C){if(B){this.clearFocus()}return}if(this._focusElement){if(B){if(!this._focusElement.meta.isa(block.ui.shape.SelectionGroup)){var D=this._focusElement;D.blur();this._focusElement=new block.ui.shape.SelectionGroup();this._focusElement.add(D)}this._focusElement.add(C);this._focusElement.draw();this._focusElement.redraw();this._focusElement.focus();document.propPanel.setShape(this._focusElement);return}else{this._focusElement.blur()}}this._focusElement=C;C.focus();document.propPanel.setShape(C)},selectAll:function(){var C=new block.ui.shape.SelectionGroup();var B=document.shapes.getElements();Joose.A.each(B,function(D){C.add(D)});C.draw();C.redraw();this.switchFocus(C)},setupShortcuts:function(){var G=this;var L={disableInInput:true};var B=function(){var M=G.getFocusElement();if(M){G.copy(M)}};var I=function(){var M=G.getFocusElement();if(M){G.copy(M);M.destroy()}};var D=function(){G.paste()};var E=function(){G.selectAll()};var K=function(){G.clearFocus()};var J=function(){var M=G.getFocusElement();if(M){M.destroy()}};var F=function(){saveDocument()};var C=function(){loadDocuments()};var H=function(){document.undo.undo()};$.hotkeys.add("Ctrl+c",L,B);$.hotkeys.add("Meta+c",L,B);$.hotkeys.add("Ctrl+v",L,D);$.hotkeys.add("Meta+v",L,D);$.hotkeys.add("Ctrl+x",L,I);$.hotkeys.add("Meta+x",L,I);$.hotkeys.add("Ctrl+a",L,E);$.hotkeys.add("Meta+a",L,E);$.hotkeys.add("Ctrl+d",L,K);$.hotkeys.add("Meta+d",L,K);$.hotkeys.add("backspace",L,J);$.hotkeys.add("del",L,J);$.hotkeys.add("Ctrl+z",L,H);$.hotkeys.add("Meta+z",L,H);$.hotkeys.add("Ctrl+s",L,F);$.hotkeys.add("Meta+s",L,F);$.hotkeys.add("Ctrl+o",L,C);$.hotkeys.add("Meta+o",L,C)},shiftKeyDown:function(){return this.getCurrentKeyCode()==16},getViewPort:function(){return $("#shapeArea")},setMaxZIndex:function(B){if(B>this.getZIndex()){this.setZIndex(B);$("#leftMenu").css("zIndex",B+1)}},nextZIndex:function(){var B=this.getZIndex()+1;this.setZIndex(B);return B},makeGuid:function(){return block.ui.Guid.create()},shapeFromGuid:function(B){return this.shapeByGuidMap[B]},copy:function(B){this.setTempStore(JSON.stringify(B))},copyFocused:function(){var B=this.getFocusElement();if(B){this.copy(B)}},syncedTime:function(){return new Date().getTime()+document.paras.timeOffset},paste:function(){var C=this.getTempStore();if(C){block.ui.Guid.startReplaceSession();var B=JSON.parse(C);B.paste(document.shapes)}}}})});Module("block.ui",function(A){Class("Query",{has:{query:{is:"rw"}},methods:{asHash:function(){return this.query},param:function(B){return this.query[B]},initialize:function(){var C=window.location.search;var E=C.split("?");var C=E[1];if(C==null){C=""}E=C.split("&");var D={};for(var B=0;B<E.length;B++){var F=E[B].split("=");D[unescape(F[0])]=unescape(F[1])}this.setQuery(D)}}})});Module("block.ui",function(A){Class("Document",{does:[Joose.Storage],has:{header:{is:"rw",init:function(){return new block.ui.DocumentHeader()}},body:{is:"rw"},id:{is:"rw",init:function(){var B=document.paras.docId;if(B!=null&&B!=""){return B}return"default"}}},methods:{getUser:function(){return this.getHeader().getUser()}}})});Module("block.ui",function(A){var C=Math.random();var B="Untitled Document";Class("DocumentHeader",{does:[Joose.Storage],has:{title:{is:"rw"},user:{is:"rw",init:function(){return document.location.search?document.location.search:C}}},methods:{touch:function(){document.manager.setDirty(true);document.sync.saveState()},changeTitle:function(D){this.setTitle(D);this.touch()},isDefaultTitle:function(){return this.getTitle==B}},after:{initialize:function(){this.setTitle(B)},setTitle:function(){document.title=(""+this.getTitle()+" - blok");$("#documentTitle").html(this.getTitle().html())}}})});Module("block.ui",function(A){Class("Element",{meta:block.ui.ElementMetaclass,does:[Joose.Storage,block.ui.role.Notification],has:{container:{is:"rw",persistent:false},$:{is:"rw",persistent:false},document:{is:"rw",init:function(){return $(document)},persistent:false},viewPort:{is:"rw",init:function(){return document.manager.getViewPort()},persistent:false},placed:{is:"rw",init:false,persistent:false},listener:{is:"rw",init:function(){return[]},persistent:false},deleted:{is:"rw",init:false},redrawTimeout:{persistent:false}},methods:{isDeleted:function(){return this.deleted},getGuid:function(){return 0},place:function(){},draw:function(){if(!this.placed&&!this.deleted){this.placed=true;this.place()}},asyncRedraw:function(){if(this.redrawTimeout){clearTimeout(this.redrawTimeout)}var B=this;this.redrawTimeout=setTimeout(function C(){B.redraw()},0)},redraw:function(){},focus:function(){},blur:function(){},isSelectionGroup:function(){return false}}})});Module("block.ui",function(A){Class("Container",{isa:block.ui.Element,has:{elements:{is:"rw",init:function(){return[]}}},after:{draw:function(){Joose.A.each(this.getElements(),function B(C){C.draw()})}},methods:{traverse:function(C,E,B){var H=this;var D=B;if(!D){D={}}myDepth=E;if(!myDepth){myDepth=0}var J=this.getElements();for(var F=0;F<J.length;F++){var I=J[F];var G=I.getGuid();if(!D[G]){D[G]=true;C(I,H,myDepth);I.traverse(C,myDepth+1,D)}}},prettyPrint:function(){var B="";var C=this;Joose.A.each(this.getElements(),function(E){B+="  "+E+"\n\n";var D=["getGuid","getLeft","getWidth","getHeight","getTop","getText","getDeleted"];Joose.A.each(D,function(G,F){if(E.meta.can(G)){B+="    "+D[F]+": "+E[G]()+"\n"}});B+=E.prettyPrint()+"\n"});return B},redraw:function(){Joose.A.each(this.getElements(),function B(C){C.redraw()})},add:function(B){this.getElements().push(B);this.propagate(B)},removeElement:function(C){var B=[];Joose.A.each(this.getElements(),function(D){if(C!==D){B.push(D)}});this.setElements(B)},propagate:function(B){B.setContainer(this);B.setDocument(this.getDocument());B.setViewPort(this.getViewPort())},finishUnpack:function(){var C=this;Joose.A.each(this.getElements(),function B(D){C.propagate(D)})},addAndDraw:function(B){this.add(B);this.draw();this.redraw()},isEmpty:function(){return this.getElements().length==0}}})});Module("block.ui",function(A){Class("Undo",{has:{_steps:{is:"rw",init:function(){return[]}},_activeTransaction:{is:"rw",init:false}},methods:{beginTransaction:function(){if(this.getActiveTransaction()){return}this.addUndoStep(function B(){},block.ui.Shape);this.setActiveTransaction(true)},commit:function(){this.setActiveTransaction(false)},undo:function(){console.log("undoing");var B=this._steps.pop();if(B){B()}},addUndoStep:function(E,B){if(!B.meta.does(block.ui.role.Group)){console.log("Add Undo step: "+B);if(this.getActiveTransaction()){var D=this._steps.pop();this._steps.push(function C(){D();E()})}else{this._steps.push(E)}if(this._steps.length>10){this._steps.shift()}}},addUpdateStep:function(D){var B=JSON.stringify(D);this.addUndoStep(function C(){console.log("Undo shape change");var E=JSON.parse(B);E.touch();D.updateFrom(E);D.touch()},D)},addCreateStep:function(C){this.addUndoStep(function B(){console.log("Undo create");C.destroy()},C)},addDestroyStep:function(B){this.addUndoStep(function C(){console.log("Undo destroy");B.setDeleted(false);B.setPlaced(false);B.touch();document.shapes.addAndDraw(B)},B)}}})});Module("block.ui",function(A){Class("Shape",{isa:block.ui.Container,has:{_left:{is:"rw",init:200},_top:{is:"rw",init:100},_width:{is:"rw"},_height:{is:"rw"},_zIndex:{is:"rw",init:-1},_minWidth:{is:"rw",init:20},_minHeight:{is:"rw",init:20},_guid:{is:"rw",init:function(){return this.initGuid()}},_lastUpdate:{is:"rw",init:0},_offsetLeft:{is:"rw",init:function(){return 150;return this.getViewPort().offset().left},lazy:true},_offsetTop:{is:"rw",init:function(){return 0;return this.getViewPort().offset().top},lazy:true},_style:{is:"rw",init:function(){return{}}}},methods:{create:function(){throw"Abstract"},initGuid:function(){return document.manager.makeGuid(this)},addDragPoints:function(){},makeDraggable:function(){},place:function(){this.$=this.create();this.getViewPort().append(this.$);var B=this.getZIndex();if(B==-1){B=document.manager.nextZIndex()}this.zIndex(B);this.x(this.getLeft());this.y(this.getTop());this.width(this.getWidth());this.height(this.getHeight());this.addDragPoints();this.makeDraggable()},prepareStorage:function(){},_updateStateCore:function(){var B=this.offset();this.setLeft(B.left);this.setTop(B.top);this.setWidth(this.width());this.setHeight(this.height())},updateState:function(){if(!this.isDeleted()){document.undo.addUpdateStep(this);this._updateStateCore();this.touch()}},touch:function(){document.propPanel.refresh(this);this.setLastUpdate(this.syncedTime());console.log("Touch: "+this.getLastUpdate());document.manager.setDirty(true);this.updated();document.sync.saveState()},_updateFromCore:function(B){if(B.isDeleted()&&!this.isDeleted()){this.destroy()}else{if(!this.isDeleted()){if(B.getLeft()!=this.getLeft()){this.x(B.getLeft())}if(B.getTop()!=this.getTop()){this.y(B.getTop())}if(B.getWidth()!=this.getWidth()){this.width(B.getWidth())}if(B.getHeight()!=this.getHeight()){this.height(B.getHeight())}this.setLastUpdate(B.getLastUpdate())}}},updateFrom:function(B){console.log(B.getLastUpdate()+">"+this.getLastUpdate());if(B.getLastUpdate()>this.getLastUpdate()){console.log("Change shape");this._updateFromCore(B);this._updateStateCore();document.propPanel.refresh(this);this.updated()}},syncedTime:function(){return document.manager.syncedTime()},offset:function(){var B=this.dim$().offset();B.left-=this.getOffsetLeft();B.top-=this.getOffsetTop();return B},left:function(D){var C=this.dim$();if(arguments.length>0){var B=this.left();C.css("left",""+D+"px");C.width(this.width()-(D-B))}else{return C.offset().left-this.getOffsetLeft()}},top:function(E){var D=this.dim$();if(arguments.length>0){var C=this.top();D.css("top",""+E+"px");D.height(this.height()-(E-C))}else{var B=D.offset().top;var F=this.getOffsetTop();return B-F}},dim$:function(){return this.$},height:function(){var B=this.dim$();return B.height.apply(B,arguments)},width:function(){var B=this.dim$();return B.width.apply(B,arguments)},right:function(B){if(arguments.length>0){this.width(B-this.left())}else{var B=this.left()+this.width();return B}},bottom:function(B){if(arguments.length>0){var C=this.top();this.height(B-C)}else{var B=this.top()+this.height();return B}},zIndex:function(B){if(arguments.length>0){this.setZIndex(B);document.manager.setMaxZIndex(B);this.$.css("zIndex",B)}else{throw"Only settable"}},x:function(B){if(arguments.length>0){this.$.css("left",""+B+"px")}else{return this.left()}},y:function(B){if(arguments.length>0){this.$.css("top",""+B+"px")}else{return this.top()}},center:function(C,B){if(arguments.length>0){this.x(Math.round(C-this.width()/2));this.y(Math.round(B-this.height()/2))}else{return{left:Math.round(this.left()+this.width()/2),top:Math.round(this.top()+this.height()/2)}}},show:function(){this.$.show()},hide:function(){this.$.hide()},resetGuid:function(){var B=this.initGuid();this.setGuid(B);this.registerGuid();this.touch();return B},paste:function(B){block.ui.Guid.replaceGuids(this);B.addAndDraw(this);document.manager.asyncSwitchFocus(this)},registerGuid:function(){document.manager.shapeByGuidMap[this.getGuid()]=this},optionalRegisterGuid:function(){if(!document.manager.shapeByGuidMap[this.getGuid()]){this.registerGuid()}},destroy:function(){this.setDeleted(true);this.$.hide();this.$.remove();this.touch();document.undo.addDestroyStep(this)},type:function(){var B=this.meta.className();return B.split(".").pop()},drawOnDoc:function(){var B=this;document.shapes.addAndDraw(B);B.touch();document.undo.addCreateStep(B);return B},overlaps:function(B){return !(B.left()>this.right()||B.right()<this.left()||B.top()>this.bottom()||B.bottom()<this.top())}},after:{initialize:function(){this.optionalRegisterGuid()}},classMethods:{addToDoc:function(B){var C=this.meta.instantiate(B);return C.drawOnDoc()}}})});Module("block.ui.shape",function(A){var B=true;Class("Grid",{isa:block.ui.Shape,has:{distance:{is:"rw",init:20},color:{is:"rw",init:"#CCCCCC"},multiSelection:{is:"rw"}},methods:{place:function(){var K=this;this.$=$("#grid");var G=this.getOffsetLeft();var F=this.getOffsetTop();var J=this.getDocument();if(B){J=$(window);B=false}var C=this.getDistance();var E=J.width()-G-1;var L=J.height()-F;var I="";for(var H=0;H<E;H+=C){I+='<div style="top: 0px; left: '+H+"px; width: 1px; height: "+L+'px"></div>\n'}for(var H=0;H<L;H+=C){I+='<div style="top: '+H+"px; left: 0px; width: "+E+'px; height: 1px"><img src="/static/t.gif" width=1 height=1 /></div>\n'}this.$.append(I);this.$.width(E);this.$.height(L);this.$.click(function(){document.manager.clearFocus()});if(document.all){return}var D;this.$.mousedown(function(R){R.preventDefault();var Q=new block.ui.shape.MultiSelection();Q.draw();Q.redraw();D=R;var O=R.pageX-G;Q.x(O);Q.y(R.pageY-F);Q.width(1);Q.height(1);K.setMultiSelection(Q);var P=$(window);var N=function(V,U){var T=U.pageX-D.pageX;var S=U.pageY-D.pageY;if(T<0){V.left(U.pageX-G);V.width(T*-1)}else{V.width(T)}if(S<0){V.top(U.pageY-F);V.height(S*-1)}else{V.height(S)}};var M=function(S){if(K.getMultiSelection()){N(K.getMultiSelection(),S)}};P.mousemove(M);P.one("mouseup",function(S){P.unbind("mousemove",M);var T=K.getMultiSelection();if(T){N(T,S);T.selectContained();T.destroy()}K.setMultiSelection(null);return true});return true})},redraw:function(){this.placed=false;this.$.html("");this.draw()},jQueryGridParameter:function(){return[this.getDistance(),this.getDistance()]}}})});Module("block.ui.shape",function(A){var B;Class("PropertiesPanel",{isa:block.ui.Shape,has:{_shape:{is:"rw"},_openEdit:{is:"rw"}},methods:{callProp:function(M,I,J){var H=$(M);var D=M.id;var G=D.substr(4).split("-");var C=G[0];var F=G[1];var L=[];if(F){L.push(F)}if(arguments.length>2){var E=""+J;if(H.attr("addPx")){E+="px"}L.push(E)}var K=H.attr("jooseDoes");if(I.meta.can(C)&&(!K||I.meta.does(I.meta.classNameToClassObject(K)))){M.disabled=false;var E=I[C].apply(I,L);if(E!=null){if(H.attr("addPx")){E=E.replace(/px/,"")}return E}else{return""}}else{M.disabled=true;return"n/a"}},handleChange:function(D,C){var E=this;if(C){E.setOpenEdit(null);document.undo.addUpdateStep(C);E.callProp(D,C,$(D).val());C.touch()}},place:function(){var C=this;this.$=$("#properties");this.redraw();this.$.find("#shapeProperties input,#shapeProperties select").each(function(){$(this).change(function(){C.handleChange(this,C.getShape())})});this.$.find("#shapeProperties input").each(function(){$(this).keypress(function(){var E=this;var D=C.getShape();C.setOpenEdit(function(){C.handleChange(E,D)})})})},show:function(){$("#shapeProperties").show();$("#documentProperties").hide();this.redraw()},hide:function(){this.executeOpenEdit();$("#shapeProperties").hide();$("#documentProperties").show();this.redraw()},executeOpenEdit:function(){var C=this.getOpenEdit();if(C){C();this.setOpenEdit(null)}},setShape:function(C){this.executeOpenEdit();this._shape=C;this.refresh(C);this.show()},refresh:function(C){if(B){clearTimeout(B)}var D=this;B=setTimeout(function(){if(C===D.getShape()){$("#shapeType").html(C.type());D.$.find("#shapeProperties input, #shapeProperties select").each(function(){$(this).val(D.callProp(this,C))});$.colorPicker.refreshSamples()}},0)},redraw:function(){var C=this.$.height();this.$.css("top",""+($(window).height()-C-20)+"px");this.$.css("width",""+($(window).width()-150)+"px")}}})});Module("block.ui.shape",function(A){Class("DragPoint",{isa:block.ui.Shape,does:block.ui.role.Draggable,has:{xMethod:{is:"rw"},yMethod:{is:"rw"}},methods:{create:function(){return jQuery("<div class='dragPoint shape'></div>")},redraw:function(){this.center(this.getContainer()[this.getXMethod()](),this.getContainer()[this.getYMethod()]())},dragHandler:function(){var B=this;return function(D){var C=B;B.getContainer()[B.getXMethod()](Math.round(B.left()+B.width()/2));B.getContainer()[B.getYMethod()](Math.round(B.top()+B.height()/2));B.getContainer().redraw();return false}}}})});Module("block.ui.shape",function(A){Class("Rectangle",{isa:block.ui.Shape,does:[block.ui.role.Draggable,block.ui.role.Resizable,block.ui.role.Focusable,block.ui.role.Editable,block.ui.role.ShapeUI,block.ui.role.Stylable,block.ui.role.Connectable],has:{_text:{is:"rw",init:""}},methods:{create:function(){return jQuery("<div class='rectangle shape stylable'><table width=100% height=100%><tr><td valign=center align=center class='textField stdText stylable'></td></tr></table></div>")}}})});Module("block.ui.shape",function(A){Class("Image",{isa:block.ui.Shape,has:{_imageUrl:{is:"rw",init:"/static/pony.jpg"}},does:[block.ui.role.Draggable,block.ui.role.Resizable,block.ui.role.Focusable],after:{place:function(){var B=this;this.$.dblclick(function(){var C=prompt("Please enter an image URL:",B.getImageUrl());if(C){B.imageUrl(C);B.updateState()}});this.imageUrl(this.getImageUrl());this.resizeImage()},_updateFromCore:function(B){this.imageUrl(B.getImageUrl());this.resizeImage()},_updateStateCore:function(){this.setImageUrl(this.imageContainer().find("img").attr("src"));this.resizeImage()}},methods:{resizeImage:function(){var B=this.imageContainer().find("img");B.width(this.getWidth());B.height(this.getHeight())},imageUrl:function(B){if(arguments.length>0){this.imageContainer().html("<img class='image' src='"+B+"' />")}return this.getImageUrl()},imageContainer:function(){return this.$.find("div div")},create:function(){return jQuery("<div class='shape'><div><div></div></div></div>")},dim$:function(){return this.$},resize$:function(){return this.$}}})});Module("block.ui.shape",function(A){Class("SelectionGroup",{isa:block.ui.Shape,does:[block.ui.role.Group],methods:{propagate:function(){},touch:function(){this.updated()},paste:function(B){Joose.A.each(this.getElements(),function(C){C.paste(B)});this.draw();this.redraw();document.manager.asyncSwitchFocus(this)},css:function(C,D){var B=arguments;if(D!=null){Joose.A.each(this.getElements(),function(E){E.css.apply(E,B)})}return""},asRealGroup:function(){var B=new block.ui.shape.Group();Joose.A.each(this.getElements(),function(C){B.add(C)});return B}}})});Module("block.ui.shape",function(A){Class("Group",{isa:block.ui.Shape,does:[block.ui.role.Group],override:{add:function(B){var C=B.getContainer();if(C){C.removeElement(B)}this.SUPER(B)}},methods:{blur:function(){this.$.addClass("groupBlurred")},focus:function(){this.$.removeClass("groupBlurred")}}})});Module("block.ui.shape",function(A){Class("MultiSelection",{isa:block.ui.Shape,does:[],methods:{create:function(){return jQuery("<div class='multiSelection shape'></div>")},touch:function(){this.updated()},selectContained:function(){var G=this.$.offset().top;var F=this.left();var C=this.right();var B=G+this.height();var E=new block.ui.shape.SelectionGroup();var D=false;document.shapes.traverse(function(H){try{if(!H.getDeleted()&&H.meta.does(block.ui.role.Focusable)){if(H.top()>=G&&H.left()>=F&&H.right()<=C&&H.bottom()<=B){E.add(H);D=true}}}catch(I){console.log(I)}});if(D){E.draw();E.redraw();document.manager.switchFocus(E)}else{document.manager.clearFocus()}}}})});Module("block.ui",function(A){Class("CustomShapeBody",{does:[Joose.Storage],has:{_html:{is:"rw",init:""},_name:{is:"rw",init:"CustomShape"},_url:{is:"rw"},_roles:{is:"rw",init:function(){return[]}},_description:{is:"rw",init:""}},methods:{getId:function(){return this.getUrl()+"/"+this.getName()}},override:{getHtml:function(){var C=this.SUPER();var B;while(B=C.match(/(\d+)\s*blok/)){var D=parseInt(B[1])*20;C=C.replace(/(\d+)\s*blok/,""+D+"px")}return C}}});Class("CustomShapeManager",{has:{_shapeBodies:{is:"rw",init:function(){return{}}}},methods:{fetch:function(C){var D=this;block.ui.SyncDocument.request("GET",C,null,function B(E){Joose.O.each(E,function(F,G){F.setUrl(C);var I=F.getId();D.setBody(F);var H=$('<li><a href="#">'+F.getName().html()+"</li>");H.click(function(){D.drawShape(I)});$("#customShapes").append(H)})})},getBody:function(B){return this.getShapeBodies()[B]},setBody:function(B){this.getShapeBodies()[B.getId()]=B},drawShape:function(D){var B=this.getBody(D);var C=new block.ui.shape.Custom({body:B});C.drawOnDoc()}}})});Module("block.ui.shape",function(A){Class("Custom",{isa:block.ui.Shape,has:{_body:{is:"rw"},_text:{is:"rw",init:""}},before:{draw:function(){this.updateBody();this.applyRoles()}},methods:{updateBody:function(){var B=document.customShapes.getBody(this.getBody().getId());if(B&&B!==this.getBody()){this.setBody(B);if(this.$){this.$.remove();this.placed=false}}},packedClassName:function(){return"block::ui::shape::Custom"},applyRoles:function(){var C=this;var B=this.getBody().getRoles();Joose.A.each(B,function(E){var D="block.ui.role."+E;var F=C.meta.classNameToClassObject(D);F.meta.apply(C)})},create:function(){var B=jQuery(this.getBody().getHtml());B.addClass("shape");B.addClass("baseSize");return B},type:function(){return this.getBody().getName()}}})});var c0,c1;function testConnection(){if(!c0){c0=new block.ui.shape.Connection()}if(!c1){c1=new block.ui.shape.Connection()}var A=document.shapes.getElements();c0.connect(A[0],A[1]);c1.connect(A[0],A[2])}Module("block.ui.shape",function(A){Class("Connector",{classMethods:{connectFocused:function(){var B=document.manager.getFocusElement();if(!B){alert("Please select at least two shapes.")}else{if(B.meta.does(block.ui.role.Group)){this.connect(B.getElements())}else{alert("Please select multiple shapes.")}}},connect:function(B){var D=[];var C=B[0];if(C){Joose.A.each(B,function(E){if(E.meta.does(block.ui.role.Connectable)){if(C&&C.center().top>E.center().top){C=E}D.push(E)}});D=Joose.A.remove(D,C);Joose.A.each(D,function(F){var E=A.Connection.addToDoc({origin:C,destination:F});E.draw();document.shapes.add(E)})}}}});Class("Connection",{isa:block.ui.Shape,does:[block.ui.role.Focusable],has:{_verticals:{is:"rw",persistent:false,init:function(){return[new A.VerticalLine(),new A.VerticalLine()]}},_horizontals:{is:"rw",persistent:false,init:function(){return[new A.HorizontalLine()]}},_origin:{is:"rw",persistent:false},_destination:{is:"rw",persistent:false},_originGuid:{is:"rw"},_destinationGuid:{is:"rw"}},methods:{changeNode:function(C,B){if(B){if(C){C.removeListener(this)}B.addListener(this)}else{console.log("There is now newNode")}},updateFrom:function(){},notify:function(B){console.log("redraw connection");if(B.isDeleted()&&!this.isDeleted()){this.destroy()}else{this.asyncRedraw()}},place:function(){this.redraw()},redraw:function(){if(!this.isDeleted()){this.connect(this.getOrigin(),this.getDestination())}},connect:function(N,M){var J=N;var K=M;if(!J||!K){console.log("Invalid parameters");return}var C=J.bottom();var F=K.top();if(J.top()>F){J=M;K=N;C=J.bottom();F=K.top()}var B=J.center();var D=K.center();var L=this.getVerticals()[0];var I=this.getVerticals()[1];var G=this.getHorizontals()[0];L.draw();L.y(C+1);L.x(B.left);var H=(F-C)/2;L.len(H);var E=D.left-B.left;G.draw();G.y(C+H);G.x(B.left);G.len(E);I.draw();I.y(C+H);I.x(B.left+E);I.len(H);if(C>F){if(J.overlaps(K)){L.hide();I.hide();G.hide()}else{L.hide();I.hide();G.show();if(B.left<D.left){G.x(J.right()+1);G.len(K.left()-J.right()-1)}else{G.x(K.right()+1);G.len(J.left()-K.right()-1)}}}else{L.show();I.show();G.show()}}},before:{setOrigin:function(B){this.changeNode(this.getOrigin(),B);this.setOriginGuid(B.getGuid())},setDestination:function(B){this.changeNode(this.getDestination(),B);this.setDestinationGuid(B.getGuid())},place:function(){if(!this.getOrigin()&&this.getOriginGuid()){this.setOrigin(document.manager.shapeFromGuid(this.getOriginGuid()))}if(!this.getDestination()&&this.getDestinationGuid()){this.setDestination(document.manager.shapeFromGuid(this.getDestinationGuid()))}}},after:{place:function(){var B=[];Joose.A.each(this.getVerticals(),function(C){if(C.$){B.push(C.$.get(0))}});Joose.A.each(this.getHorizontals(),function(C){if(C.$){B.push(C.$.get(0))}});this.$=$(B)}}});Class("HorizontalLine",{isa:block.ui.Shape,does:[block.ui.role.Stylable],has:{},methods:{create:function(){return jQuery("<div class='line horizontalLine shape'></div>")},getLength:function(){return this.getWidth()},updateFrom:function(){},setLength:function(B){this.setWidth(B);if(B>=0){this.width(B)}else{B=Math.abs(B);this.x(this.left()-B);this.width(B)}},redraw:function(){this.len(this.getLength())},len:function(B){if(arguments.length>0){this.setLength(B)}return this.width()}}});Class("VerticalLine",{isa:A.HorizontalLine,methods:{create:function(){return jQuery("<div class='line verticalLine shape'></div>")},getLength:function(){return this.getHeight()},setLength:function(B){this.setHeight(B);if(B>=0){this.height(B)}else{B=Math.abs(B);this.y(this.top()-B);this.height(B)}}}})});Module("block.ui",function(A){Class("Template",{has:{_url:{is:"rw"}},methods:{loadAndDraw:function(){block.ui.SyncDocument.request("GET",this.getUrl(),null,function B(C){block.ui.Guid.startReplaceSession();C.paste(document.shapes)})}}})});Module("block.ui",function(A){Class("User",{has:{id:{is:"rw",init:document.paras.userName}},methods:{loggedIn:function(){return document.paras.userName!=""},login:function(B){var C=window.location.href;C.replace(/#.+/,"");C+="&action="+B;window.location.href="/login?continue="+encodeURIComponent(C)},saveCurrentDocument:function(){if(this.loggedIn()){document.manager.setDirty(true);document.sync.saveState();block.ui.SyncDocument.request("GET","/save",{hash:document.paras.docId},function B(C){alert("The document was successfully saved.")})}else{this.login("save")}},loadDocuments:function(C){if(this.loggedIn()){block.ui.SyncDocument.request("GET","/documents",null,function B(D){C(D)})}else{this.login("open")}}}})});JooseGearsInitializeGears();Module("block.ui",function(A){var B;Class("Sync",{has:{_maxVersion:{is:"rw",init:0},_doc:{is:"rw"},_firstUpdate:{is:"rw",init:true},_syncInterval:{is:"rw"},_syncTime:{is:"rw"},_saveTimeout:{is:"rw"}},methods:{delayedUpdate:function(){var D=this;clearTimeout(B);B=window.setTimeout(function C(){D.update()},5000)},startListening:function(){var C=this;window.setInterval(function D(){var F=C.getSyncTime();var E=new Date().getTime();if(E-F>20000){C.update()}},5000)},update:function(){this.setSyncTime(new Date().getTime());this.fetchStates()},updateFromArray:function(F){var D=this;for(var C=0;C<F.length;C++){var G=F[C];console.log("Update from version "+G.version);var E=G.data;D.updateDocument(E)}this.fireFirstDraw();this.delayedUpdate()},updateDocument:function(D){console.log("Got something new!");var E;var C=D.getBody();var G=D.getHeader().getTitle();if(G!=null){this.getDoc().getHeader().setTitle(G)}C.traverse(function F(I,H){var K=document.manager.shapeByGuidMap;var L=K[I.getGuid()];if(L){console.log("Update");if(!L.isDeleted()){L.updateFrom(I);if(L.getContainer().getGuid()!=H.getGuid()){L.getContainer().removeElement(L);var J=K[H.getGuid()];if(J){J.add(L)}else{console.log("Cannot find "+H.getGuid())}}}}else{console.log("Insert");var J;if(H===C){J=document.shapes}else{J=K[H.getGuid()];if(J){J.add(L)}else{console.log("Cannot find "+H.getGuid())}}if(!I.isDeleted()){I.registerGuid();J.addAndDraw(I)}}})},fireFirstDraw:function(){if(this.getFirstUpdate()){window.onfirstdraw();this.setFirstUpdate(false)}},fetchStates:function(){return A.SyncDocument.fetchNewData(this)},_saveState:function(){var D=this.getSaveTimeout();if(D){clearTimeout(D)}var C=this;this.setSaveTimeout(window.setTimeout(function(){A.SyncDocument.addData(C,false)},2000))},saveState:function(){if(document.manager.getDirty()){this.delayedUpdate();saveMessage("Saving...");this._saveState();document.manager.setDirty(false)}},savePermanent:function(){return A.SyncDocument.addData(this,true)},syncedTime:function(){return new Date().getTime()}}});Class("SyncDocument",{classMethods:{fetchNewData:function(E){var C=[];var F=[];var H=E.getDoc();var G=E.getMaxVersion()||0;this.request("GET","/fetch",{hash:H.getId(),max_version:G,session:document.paras.sessionId,no_cache:Math.random()},function D(K){console.log("Got data "+K+" Length: "+K.data.length+" (Requested from version "+G+"/"+Math.round(document.manager.syncedTime()/1000)+")");F=K.data;var J=K.max_version;for(var I=0;I<F.length;I++){console.log("Row version "+F[I].version);C.push({data:JSON.parse(F[I].data),version:F[I].version})}E.updateFromArray(C);if(J>0){E.setMaxVersion(J)}})},addData:function(E,G){var D=new A.SyncDocument();var H=E.getDoc();var F=JSON.stringify(E.getDoc());this.request("POST","/add",{hash:H.getId(),data:F,is_savepoint:G,name:H.getHeader().getTitle(),session:document.paras.sessionId},function C(){window.saveMessage("Saved");console.log("save successful")})},request:function(I,C,E,H){try{Joose.Gears.ajaxRequest(I,C,E,function G(J){H(JSON.parse(J))},function D(J){console.log("Error fetching url "+J.url+". Response code: "+J.status+" Response text: "+J.responseText)})}catch(F){console.log(F)}}}})});if(!window.console){window.console={log:function log(A){}}}Joose.Storage.Unpacker.patchJSON();$(document).ready(function docReady(){document.title="Loading...";initializeDialogs();$("#leftMenu h2").click(function(){$(this).parent().find("ul").toggle()});document.query=new block.ui.Query();document.user=new block.ui.User();document.manager=new block.ui.Manager();document.manager.setupShortcuts();document.grid=new block.ui.shape.Grid({container:$("#grid")});document.grid.draw();$(".colorPicker").attachColorPicker();document.propPanel=new block.ui.shape.PropertiesPanel();document.propPanel.draw();$(window).resize(function B(){document.propPanel.redraw();document.grid.redraw()});$(window).scroll(function A(){document.grid.redraw()});$("#share").focus(function(){this.select()});document.shapes=new block.ui.Container({$:$("#shapeArea")});var C=new block.ui.Document({body:document.shapes});document.sync=new block.ui.Sync({doc:C});document.sync.update();document.sync.startListening();document.undo=new block.ui.Undo();document.customShapes=new block.ui.CustomShapeManager()});function initializeDialogs(){$("#stateDialog").dialog();$("#stateDialog").dialog("close");$("#welcomeDialog").dialog({height:"400px",width:"500px"});$("#welcomeDialog").dialog("close");$("#loadDialog").dialog({height:"300px",width:"400px"});$("#loadDialog").dialog("close")}function loadTemplate(A){var B=new block.ui.Template({url:A});B.loadAndDraw()}function closeWelcomeDialog(){$("#welcomeDialog").dialog("close")}function showState(){var A=document.shapes.prettyPrint();$("#stateDialog textarea").val(A);$("#Dialog").dialog("open")}function showClipboardContent(){var A=document.manager.getTempStore()||"empty";$("#stateDialog textarea").val(A);$("#stateDialog").dialog("open")}function read(){$("#shapeArea").html("");var A=document.getElementById("outputArea").value;if(A!=null&&A!=""){document.shapes=JSON.parse(A);document.shapes.draw();document.shapes.redraw();document.sync.getDoc().setBody(document.shapes)}}function changeName(){var B=document.sync.getDoc().getHeader().getTitle();var A=prompt("Save as:",B);if(A){document.sync.getDoc().getHeader().changeTitle(A);return true}return false}function write(){document.getElementById("outputArea").value=JSON.stringify(document.shapes)}function saveDocument(){if(changeName()){document.user.saveCurrentDocument()}}function loadDocuments(){var B=$("#documentList");B.html("Loading...");$("#loadDialog").dialog("open");var A="<table class=list>";A+="<tr><th>Name</th><th>Last Update</th></tr>";document.user.loadDocuments(function(D){var C=0;Joose.A.each(D,function(E){A+="<tr class=listItem onclick=\"loadDocument('"+E.hash.html()+"')\"><td>"+E.name.html()+"</td><td>"+E.lastUpdate.html()+"</td></tr>\n";C++});if(C==0){A+="<tr><td colspan=2>You have not yet saved any documents.</td></tr>"}A+="</table>";B.html(A)})}function loadDocument(A){location.href="/?id="+A}function saveMessage(A){$("#saveMessage").html(A)}function doInitialAction(){window.setTimeout(function(){document.propPanel.redraw()},1000);if(document.shapes.isEmpty()){var A=document.query.param("template");if(A&&A.length>0){loadTemplate(A)}else{$("#welcomeDialog").dialog("open")}}var B=document.query.param("action");if(B=="save"){saveDocument()}if(B=="open"){loadDocuments()}};